I"ğ<h4 id="æ¡†æ¶ç®€ä»‹">æ¡†æ¶ç®€ä»‹</h4>

<p>Flask æ˜¯ç”± python å®ç°çš„ä¸€ä¸ª web å¾®æ¡†æ¶, æœ‰å¯¹åº”çš„ python3 åŠ python2 ç‰ˆæœ¬.
éå¸¸é€‚ç”¨äºå°å‹ç½‘ç«™, éå¸¸é€‚ç”¨äºå¼€å‘ web æœåŠ¡çš„ API, 
å¼€å‘å¤§å‹ç½‘ç«™æ— å‹åŠ›, ä½†ä»£ç æ¶æ„éœ€è¦è‡ªå·±è®¾è®¡, å¼€å‘æˆæœ¬å–å†³äºå¼€å‘è€…çš„èƒ½åŠ›å’Œç»éªŒ.
Flask è‡ªç”±ã€çµæ´», å¯æ‰©å±•æ€§å¼º, ç¬¬ä¸‰æ–¹åº“çš„é€‰æ‹©é¢å¹¿, å¼€å‘æ—¶å¯ä»¥ç»“åˆè‡ªå·±æœ€å–œæ¬¢ç”¨çš„è½®å­, ä¹Ÿèƒ½ç»“åˆæœ€æµè¡Œæœ€å¼ºå¤§çš„ Python åº“.
ä¸ªäººä¹Ÿå°† Flask ä½œä¸º web å¼€å‘çš„é¦–é€‰æ¡†æ¶.</p>

<ul>
  <li>hello world</li>
</ul>

<p>è¿™æ˜¯ä¸€ä¸ª Flask çš„ hello world ä¾‹å­, è®¿é—®æµè§ˆå™¨ä¸»é¡µå°†è¾“å‡º â€œhello worldâ€.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>from flask import Flask

app = Flask(__name__)


@app.route('/', methods=['GET'])
def get_hello_world():
    return "hello world"


app.run(port=8080)
</code></pre></div></div>

<p>Flask çš„ handler ä»¥å‡½æ•°ä¸ºå•ä½è¿›è¡Œç»„ç»‡, é€šè¿‡ <code class="highlighter-rouge">@app.route</code> è£…é¥°å™¨æŠŠ handler æ³¨å†Œåˆ°è·¯ç”±è¡¨, <code class="highlighter-rouge">app.run(port=8080)</code> ç›‘å¬æœ¬åœ° 8080,
ä¸€ä¸ªç®€å•çš„ api æœåŠ¡å°±æ­å»ºå®Œæˆäº†.</p>

<p>å¦‚æœè¦æ»¡è¶³å•†ä¸šåº”ç”¨çš„å¼€å‘, å¯ä»¥æ ¹æ®å®é™…éœ€è¦, é€‰æ‹© Flask çš„å·²æœ‰ç»„ä»¶, æˆ–è€…å…¶ä»–ä¸°å¯Œçš„ Python åº“, æ­ç§¯æœ¨å¼å¼€å‘æ¨¡å¼è®©å¼€å‘è€…å¾—å¿ƒåº”æ‰‹.</p>

<h4 id="è·¯ç”±æ³¨å†Œè¿‡ç¨‹">è·¯ç”±æ³¨å†Œè¿‡ç¨‹</h4>

<ul>
  <li>@app.route(â€˜/â€™, methods=[â€˜GETâ€™])</li>
</ul>

<p>è£…é¥°å™¨çš„å®šä¹‰:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    def route(self, rule, **options):
        def decorator(f):
            endpoint = options.pop('endpoint', None)
            self.add_url_rule(rule, endpoint, f, **options)
            return f
        return decorator
</code></pre></div></div>

<ul>
  <li>add_url_rule</li>
</ul>

<p>è·¯ç”±çš„æ³¨å†Œæ˜¯é€šè¿‡ add_url_rule å‡½æ•°å®ç°çš„, æœ€ç»ˆæ³¨å†Œåœ¨ app.view_functions å­—å…¸ä¸­. 
key æ˜¯ endpoint (é»˜è®¤ä¸ºå‡½æ•°å), value æ˜¯ view_func (handler å‡½æ•°å¼•ç”¨).</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    def add_url_rule(self, rule, endpoint=None, view_func=None, **options):
        if endpoint is None:
            endpoint = _endpoint_from_view_func(view_func)
        options['endpoint'] = endpoint
        methods = options.pop('methods', None)

        # if the methods are not given and the view_func object knows its
        # methods we can use that instead.  If neither exists, we go with
        # a tuple of only ``GET`` as default.
        if methods is None:
            methods = getattr(view_func, 'methods', None) or ('GET',)
        if isinstance(methods, string_types):
            raise TypeError('Allowed methods have to be iterables of strings, '
                            'for example: @app.route(..., methods=["POST"])')
        methods = set(item.upper() for item in methods)

        # Methods that should always be added
        required_methods = set(getattr(view_func, 'required_methods', ()))

        # Add the required methods now.
        methods |= required_methods
        rule = self.url_rule_class(rule, methods=methods, **options)

        self.url_map.add(rule)
        if view_func is not None:
            old_func = self.view_functions.get(endpoint)
            if old_func is not None and old_func != view_func:
                raise AssertionError('View function mapping is overwriting an '
                                     'existing endpoint function: %s' % endpoint)
            self.view_functions[endpoint] = view_func
</code></pre></div></div>

<ul>
  <li>app.url_map.add(rule)</li>
</ul>

<p>å€¼å¾—æ³¨æ„çš„æ˜¯ url ä¸ view_func å¹¶éæ˜¯ç›´æ¥æ˜ å°„çš„å…³ç³», ä¸­ä»‹æ¡¥æ¢æ˜¯ endpoint, url -&gt; endpoint -&gt; view_func.
<code class="highlighter-rouge">rule = self.url_rule_class(rule, methods=methods, **options)</code> å°† rule å’Œ endpoint ç»‘å®š.</p>

<p>æˆ‘ä»¬çœ‹çœ‹ <code class="highlighter-rouge">self.url_map.add(rule)</code> çš„ç»†èŠ‚.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Rule(RuleFactory):

    def __init__(self, string, defaults=None, subdomain=None, methods=None,
                 build_only=False, endpoint=None, strict_slashes=None,
                 redirect_to=None, alias=False, host=None):
        # url path
        self.rule = string
        
        # app.view_functions key
        self.endpoint = endpoint
        
        # methods: "GET", "POST" ...
        if methods is None: 
            self.methods = None
        else:
            if isinstance(methods, str):
                raise TypeError('param `methods` should be `Iterable[str]`, not `str`')
            self.methods = set([x.upper() for x in methods])
            if 'HEAD' not in self.methods and 'GET' in self.methods:
                self.methods.add('HEAD')
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Map(object):

    def __init__(self):
        self._rules = []
        self._rules_by_endpoint = {}
        self._remap = True

    def add(self, rulefactory):
        for rule in rulefactory.get_rules(self):
            rule.bind(self)
            self._rules.append(rule)
            self._rules_by_endpoint.setdefault(rule.endpoint, []).append(rule)
        self._remap = True
</code></pre></div></div>

<p>ä¸Šè¿°ä»£ç åœ¨ app.url_map._rules ä¿å­˜äº† url_rule_class (url -&gt; endpoint çš„ç»‘å®šå…³ç³»)</p>

<h4 id="è·¯ç”±æŸ¥æ‰¾è¿‡ç¨‹">è·¯ç”±æŸ¥æ‰¾è¿‡ç¨‹</h4>

<p>è¿™æ˜¯ç®€åŒ–çš„ Flask å“åº”å¤„ç†è¿‡ç¨‹ä¼ªä»£ç , è·¯ç”±çš„æŸ¥æ‰¾è¿‡ç¨‹å‘ç”Ÿåœ¨ dispatch_request():match_request() å‡½æ•°ä¸­.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def wsgi_app(environ, start_response):
  with RequestContext(environ):
    rv = dispatch_request()
    response = make_response(rv)
    response = process_response(response)
    return response(environ, start_response)    
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    def dispatch_request(self):
         url_rule, view_args = self.match_request()
         return self.view_functions[url_rule.endpoint](**view_args)
</code></pre></div></div>

<p>å…·ä½“çš„è·¯ç”±æŸ¥æ‰¾åŒ¹é…è¿‡ç¨‹ä»£ç å¦‚ä¸‹:</p>

<p>(1) ä» app.url_map._rules ä¸­éå†å‡º rule (url endpoint ç»‘å®šçš„ç±»)
(2) é€šè¿‡ url çš„è·¯å¾„ path æ­£åˆ™åŒ¹é…æŸ¥æ‰¾
(3) è¿”å›åŒ¹é…çš„ rule</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class MapAdapter(object):

    def match(self, path_info=None, method=None, query_args=None):
        have_match_for = set()

        for rule in self.map._rules:
            rv = rule.match(path)
            if rv is None:
                continue
            if rule.methods is not None and method not in rule.methods:
                have_match_for.update(rule.methods)
                continue

            return rule, rv

        if have_match_for:
            raise MethodNotAllowed(valid_methods=list(have_match_for))

        raise NotFound()
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Rule(RuleFactory):

    def match(self, path, method=None):
        m = self._regex.search(path)
        if m is not None:
            return {}
        return None
</code></pre></div></div>

<h4 id="ç»“è®º">ç»“è®º</h4>

<p>Flask çš„è·¯ç”±æœ‰ä¸¤éƒ¨åˆ†ç»„æˆ, ä¸€ä¸ªæ˜¯ view_functions å­—å…¸, å­˜å‚¨ç€å‡½æ•°å endpoint å’Œå‡½æ•°å¼•ç”¨ view_func ä¸€ä¸€å¯¹åº”å…³ç³», 
å¦ä¸€ä¸ªéƒ¨åˆ†æ˜¯ url_map, å­˜å‚¨çš„ rules æ•°ç»„, æ•°ç»„æˆå‘˜æ˜¯ Rule å¯¹è±¡, è®°å½•ç€ url å’Œ endpoint çš„ä¸€ä¸€å¯¹åº”å…³ç³».
é€šè¿‡éå†æ•°ç»„ app.map._rules, æ­£åˆ™åŒ¹é…æŸ¥æ‰¾ url, æœ€ç»ˆè°ƒç”¨ view_func.</p>
:ET